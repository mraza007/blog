{% assign maxRelated = 3 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}
{% assign relatedPosts = "" | split: "" %}

{% for post in site.posts %}
{% assign sameTagCount = 0 %}
{% for tag in post.tags %}
{% if post.url != page.url %}
{% if page.tags contains tag %}
{% assign sameTagCount = sameTagCount | plus: 1 %}
{% endif %}
{% endif %}
{% endfor %}
{% if sameTagCount >= minCommonTags %}
{% if maxRelatedCounter < maxRelated %} {% assign relatedPosts=relatedPosts | push: post %} {% assign
  maxRelatedCounter=maxRelatedCounter | plus: 1 %} {% endif %} {% endif %} {% endfor %} {% if relatedPosts.size> 0 %}
  <div class="related-posts">
    <h3>Related Posts</h3>
    <ul class="related-posts-list">
      {% for post in relatedPosts %}
      <li class="related-post-item">
        <a href="{{ post.url }}">{{ post.title }}</a>
        <small>{{ post.date | date: "%B %d, %Y" }}</small>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% else %}
  <div class="related-posts">
    <h3>Recent Posts</h3>
    <ul class="related-posts-list">
      {% for post in site.posts limit:3 %}
      {% if post.url != page.url %}
      <li class="related-post-item">
        <a href="{{ post.url }}">{{ post.title }}</a>
        <small>{{ post.date | date: "%B %d, %Y" }}</small>
      </li>
      {% endif %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}